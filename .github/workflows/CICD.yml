name: Industrialisation continue sur le serveur Alwaysdata
on: push
jobs:
  Connexion:
    runs-on: ubuntu-latest
    steps:
      - name: Connexion SSH avec le serveur
        uses: appleboy/ssh-action@master
        with:
          host: "ssh-${{ secrets.USERNAME }}.alwaysdata.net"
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          script: |
            cd $HOME/www/
  Copy:
    needs: Connexion
    runs-on: ubuntu-latest
    steps:
      - name: Connexion SSH avec le serveur
        uses: appleboy/ssh-action@master
        with:
          host: "ssh-${{ secrets.USERNAME }}.alwaysdata.net"
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          script: |
            # Cloner dans un dossier temporaire unique
            tmp_dir=$(basename ${{ runner.workspace }})
            cd $HOME/www
            # git clone https://github.com/sizanic/flask_AD.git
            git clone https://github.com/${{ github.repository }}.git $tmp_dir
            # V√©rifier si le r√©pertoire de destination existe
            if [ -d "flask_AD" ]; then
              echo "üìÅ R√©pertoire flask_AD d√©tect√©, synchronisation..."

              # Synchronisation en excluant les fichiers sensibles
              rsync -a --delete --exclude='run/' --exclude='*.pyc' --exclude='__pycache__/' "$tmp_dir/" "flask_AD/"

              # Nettoyage de fichiers inaccessibles pour √©viter les erreurs rsync
              # sudo find flask_AD/run/systemd -type d -exec chmod +x {} \; || true
              echo "${{ secrets.PASSWORD }}" | sudo -S find flask_AD -type d -exec chmod +x {} \;

              # Copier le contenu sans passer par les fichiers syst√®mes sensibles
              #              rsync -a --exclude='run/systemd' --delete "$tmp_dir/" "flask_AD/"
  
              echo "‚úÖ Mise √† jour termin√©e"
            else
              echo "‚ùå Le r√©pertoire flask_AD n'existe pas"
            fi
            
            # Nettoyage
            echo "${{ secrets.PASSWORD }}" | sudo -S chmod -R u+rwX flask_AD/
            rm -rf "$tmp_dir"
  Restart:
    needs: Copy
    runs-on: ubuntu-latest
    steps:
      - name: Restart Alwaysdata site
        run: |
          response_code=$(curl -s -o /dev/null -w "%{http_code}" -X POST --basic --user "${{ secrets.ALWAYSDATA_TOKEN }}:" https://api.alwaysdata.com/v1/site/${{ secrets.ALWAYSDATA_SITE_ID }}/restart/)
          # V√©rifier le code de r√©ponse HTTP
          if [ "$response_code" -eq 204 ]; then
            echo "Relance de votre site r√©ussi"
          elif [ "$response_code" -eq 404 ]; then
            echo "Vous n'avez pas renseigner correctement votre secret ALWAYSDATA_SITE_ID"
            exit 1  # Quitter avec un code d'erreur
          elif [ "$response_code" -eq 401 ]; then
            echo "Vous n'avez pas renseigner correctement votre secret ALWAYSDATA_TOKEN"
          exit 1  # Quitter avec un code d'erreur
          else
            echo "√âchec du red√©marrage avec le code de r√©ponse : $response_code"
            exit 1  # Quitter avec un code d'erreur
          fi
